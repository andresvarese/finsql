<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinSQL</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f2ec;
  --surface: #faf8f4;
  --surface2: #eeeae2;
  --border: #ddd8ce;
  --border2: #c8c2b6;
  --ink: #1a1814;
  --ink2: #6b6560;
  --ink3: #a09a92;
  --red: #c0392b;
  --green: #27ae60;
  --blue: #2471a3;
  --orange: #d35400;
  --yellow: #f39c12;
  --accent: #1a1814;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  overflow: hidden;
}

/* â”€â”€ PIN SCREEN â”€â”€ */
#pinScreen {
  position: fixed; inset: 0;
  background: var(--ink);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: 40px;
}
.pin-logo {
  font-family: 'Syne', sans-serif;
  font-size: 32px;
  font-weight: 800;
  color: var(--bg);
  letter-spacing: -1px;
}
.pin-logo span { color: #c8f060; }
.pin-display {
  display: flex; gap: 16px;
}
.pin-dot {
  width: 16px; height: 16px;
  border-radius: 50%;
  border: 2px solid #444;
  transition: all 0.15s;
}
.pin-dot.filled { background: #c8f060; border-color: #c8f060; }
.pin-dot.error { background: var(--red); border-color: var(--red); }
.pin-pad {
  display: grid;
  grid-template-columns: repeat(3, 64px);
  gap: 10px;
}
.pin-btn {
  width: 64px; height: 64px;
  border-radius: 12px;
  border: 1px solid #333;
  background: #242220;
  color: var(--bg);
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.1s;
  display: flex; align-items: center; justify-content: center;
}
.pin-btn:hover { background: #333; border-color: #555; }
.pin-btn:active { transform: scale(0.94); }
.pin-btn.del { font-size: 14px; color: var(--ink3); }
.pin-hint { font-size: 10px; color: #444; letter-spacing: 1px; }

/* â”€â”€ NAV â”€â”€ */
nav {
  height: 56px;
  background: var(--ink);
  display: flex; align-items: center;
  padding: 0 24px; gap: 0;
  position: relative; z-index: 100;
}
.logo {
  font-family: 'Syne', sans-serif;
  font-size: 20px; font-weight: 800;
  color: var(--bg);
  letter-spacing: -0.5px;
  margin-right: 32px;
}
.logo span { color: #c8f060; }
.nav-tabs { display: flex; gap: 2px; }
.nav-tab {
  padding: 6px 16px;
  border-radius: 4px; border: none;
  background: transparent;
  color: #666;
  font-family: 'DM Mono', monospace;
  font-size: 11px; cursor: pointer;
  letter-spacing: 0.5px;
  transition: all 0.15s;
}
.nav-tab.active { background: #2a2824; color: var(--bg); }
.nav-tab:hover:not(.active) { color: #aaa; }
.nav-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
.data-status {
  display: flex; align-items: center; gap: 7px;
  padding: 5px 12px;
  border-radius: 20px;
  border: 1px solid #333;
  font-size: 10px; color: #666;
}
.status-dot { width: 5px; height: 5px; border-radius: 50%; background: #444; }
.status-dot.on { background: #c8f060; box-shadow: 0 0 6px #c8f060; }
.btn-sync {
  padding: 6px 14px;
  border-radius: 4px; border: none;
  background: #c8f060; color: var(--ink);
  font-family: 'DM Mono', monospace;
  font-size: 10px; font-weight: 500;
  cursor: pointer; letter-spacing: 0.5px;
  transition: all 0.15s;
}
.btn-sync:hover { background: #d4f572; }
.btn-sync:disabled { opacity: 0.4; cursor: not-allowed; }

/* â”€â”€ VIEWS â”€â”€ */
.view { display: none; height: calc(100vh - 56px); }
.view.active { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#view-dashboard { flex-direction: column; overflow: hidden; }

.dash-header {
  padding: 20px 24px 0;
  display: flex; align-items: baseline;
  justify-content: space-between;
  flex-shrink: 0;
}
.dash-title {
  font-family: 'Syne', sans-serif;
  font-size: 22px; font-weight: 800;
  letter-spacing: -0.5px;
}
.dash-subtitle { font-size: 10px; color: var(--ink3); margin-top: 3px; }
.dash-period {
  display: flex; gap: 6px;
}
.period-btn {
  padding: 5px 12px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--ink2);
  font-family: 'DM Mono', monospace;
  font-size: 10px; cursor: pointer;
  transition: all 0.12s;
}
.period-btn.active { background: var(--ink); color: var(--bg); border-color: var(--ink); }

/* KPI row */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  padding: 16px 24px;
  flex-shrink: 0;
}
.kpi {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 16px;
}
.kpi-label { font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--ink3); margin-bottom: 6px; }
.kpi-value { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
.kpi-value.pos { color: var(--green); }
.kpi-value.neg { color: var(--red); }
.kpi-value.neu { color: var(--blue); }
.kpi-sub { font-size: 10px; color: var(--ink3); margin-top: 4px; }

/* Chart grid */
.chart-grid {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 24px 24px;
  display: grid;
  grid-template-columns: 2fr 1fr;
  grid-template-rows: auto auto auto;
  gap: 12px;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

.chart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  display: flex; flex-direction: column;
}
.chart-card.wide { grid-column: 1 / -1; }
.chart-card.tall { grid-row: span 2; }

.cc-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.cc-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 600; }
.cc-meta { font-size: 9px; color: var(--ink3); }
.cc-body {
  flex: 1; padding: 16px;
  min-height: 200px;
  position: relative;
  display: flex; align-items: center; justify-content: center;
}
.cc-body canvas { max-width: 100%; max-height: 100%; }

.no-data {
  font-size: 11px; color: var(--ink3);
  display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.no-data-icon { font-size: 28px; opacity: 0.3; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDITOR VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#view-editor { flex-direction: row; }

.sidebar {
  width: 260px; min-width: 260px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.sec { border-bottom: 1px solid var(--border); padding: 14px; }
.sec-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--ink3); margin-bottom: 8px; }
.schema-scroll { max-height: 200px; overflow-y: auto; scrollbar-width: thin; }
.schema-row { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid var(--border); font-size: 10px; }
.schema-row:last-child { border: none; }
.s-name { color: var(--ink); }
.s-type { color: var(--blue); }
.empty-hint { color: var(--ink3); font-size: 10px; font-style: italic; }

/* Saved queries */
.saved-list { flex: 1; overflow-y: auto; scrollbar-width: thin; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
.saved-item {
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 5px; cursor: pointer;
  transition: all 0.12s;
  display: flex; align-items: center; gap: 8px;
}
.saved-item:hover { border-color: var(--ink); background: var(--surface2); }
.saved-item-title { flex: 1; font-size: 11px; color: var(--ink); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.saved-item-del { background: none; border: none; color: var(--ink3); cursor: pointer; font-size: 13px; padding: 0; line-height: 1; }
.saved-item-del:hover { color: var(--red); }

.editor-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.editor-toolbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 16px;
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
}
.chart-pills { display: flex; gap: 4px; }
.cpill {
  padding: 5px 10px; border-radius: 4px;
  border: 1px solid var(--border);
  background: transparent; color: var(--ink3);
  font-family: 'DM Mono', monospace; font-size: 10px;
  cursor: pointer; transition: all 0.12s;
}
.cpill.active { border-color: var(--ink); color: var(--ink); background: var(--surface2); }
.cpill:hover:not(.active) { color: var(--ink2); }

.sql-wrap { flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 10px; min-height: 0; }
textarea#sql {
  flex: 1; min-height: 80px; max-height: 200px;
  background: var(--ink); border: none; border-radius: 6px;
  color: #c8f060;
  font-family: 'DM Mono', monospace; font-size: 12px;
  line-height: 1.75; padding: 14px; resize: vertical; outline: none;
}

.run-bar { display: flex; align-items: center; gap: 8px; }
.btn { padding: 7px 16px; border-radius: 4px; border: none; font-family: 'DM Mono', monospace; font-size: 11px; cursor: pointer; transition: all 0.14s; letter-spacing: 0.3px; white-space: nowrap; }
.btn-run { background: var(--ink); color: var(--bg); font-weight: 500; }
.btn-run:hover { background: #333; }
.btn-add { background: var(--blue); color: #fff; }
.btn-add:hover { background: #1a5f8a; }
.btn-add:disabled { opacity: 0.3; cursor: not-allowed; }
.btn-save { background: transparent; color: var(--ink2); border: 1px solid var(--border); }
.btn-save:hover { border-color: var(--ink); color: var(--ink); }
.btn-save:disabled { opacity: 0.3; cursor: not-allowed; }
.err-box { padding: 8px 12px; background: #fdf0ef; border: 1px solid #e8c4c0; border-radius: 4px; color: var(--red); font-size: 10px; }

.preview-area { flex: 1; min-height: 0; display: flex; border-top: 1px solid var(--border); overflow: hidden; }
.preview-chart { flex: 1; padding: 16px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.preview-table { width: 320px; min-width: 320px; border-left: 1px solid var(--border); overflow: auto; scrollbar-width: thin; }

.rtable { width: 100%; border-collapse: collapse; }
.rtable thead th { position: sticky; top: 0; background: var(--surface2); padding: 7px 12px; text-align: left; font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--ink3); border-bottom: 1px solid var(--border); }
.rtable tbody td { padding: 6px 12px; border-bottom: 1px solid var(--border); font-size: 11px; color: var(--ink); }
.rtable tbody tr:hover td { background: var(--surface2); }
.rtable tbody tr:last-child td { border: none; }
.num { text-align: right; color: var(--blue); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUSTOM WIDGETS VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#view-widgets { flex-direction: column; overflow: hidden; }

.widgets-toolbar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 10px 20px; display: flex; align-items: center; gap: 10px; flex-shrink: 0;
}
.widgets-grid {
  flex: 1; overflow-y: auto; padding: 20px;
  display: grid; grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
  gap: 14px; align-content: start;
  scrollbar-width: thin;
}
.widget-empty {
  grid-column: 1/-1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 10px;
  color: var(--ink3); padding: 80px 0;
}
.widget-empty-icon { font-size: 40px; opacity: 0.25; }

.widget { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; transition: border-color 0.15s; }
.widget:hover { border-color: var(--border2); }
.widget.dragging { opacity: 0.35; }
.widget.drag-over { border-color: var(--ink); border-style: dashed; }
.widget-header { display: flex; align-items: center; gap: 8px; padding: 9px 12px; border-bottom: 1px solid var(--border); background: var(--surface2); cursor: grab; }
.widget-header:active { cursor: grabbing; }
.drag-handle { color: var(--ink3); font-size: 13px; user-select: none; }
.widget-title { flex: 1; font-size: 11px; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: text; outline: none; border: none; background: transparent; font-family: 'DM Mono', monospace; }
.widget-title:focus { color: var(--blue); }
.wct-row { display: flex; gap: 2px; padding: 0 4px; border-right: 1px solid var(--border); }
.wct-btn { padding: 2px 6px; border-radius: 3px; border: none; background: transparent; color: var(--ink3); font-family: 'DM Mono', monospace; font-size: 9px; cursor: pointer; transition: all 0.12s; }
.wct-btn.active { background: var(--ink); color: var(--bg); }
.wa-btn { background: none; border: none; color: var(--ink3); cursor: pointer; font-size: 12px; padding: 2px 4px; border-radius: 3px; transition: all 0.12s; }
.wa-btn:hover { background: var(--surface); color: var(--red); }
.widget-body { min-height: 220px; max-height: 280px; padding: 14px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.widget-body canvas { max-width: 100%; max-height: 100%; }
.widget-footer { padding: 5px 12px; border-top: 1px solid var(--border); font-size: 9px; color: var(--ink3); display: flex; justify-content: space-between; background: var(--surface2); }

/* Modal */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(26,24,20,0.6); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border2); border-radius: 10px; padding: 22px; width: 380px; max-width: 90vw; display: flex; flex-direction: column; gap: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
.modal h3 { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
.modal label { font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--ink3); display: block; margin-bottom: 4px; }
.modal input { width: 100%; background: var(--bg); border: 1px solid var(--border2); border-radius: 4px; color: var(--ink); font-family: 'DM Mono', monospace; font-size: 12px; padding: 8px 10px; outline: none; }
.modal input:focus { border-color: var(--ink); }
.modal-btns { display: flex; gap: 8px; justify-content: flex-end; }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>

<!-- â•â• PIN SCREEN â•â• -->
<div id="pinScreen">
  <div class="pin-logo">Fin<span>SQL</span></div>
  <div class="pin-display">
    <div class="pin-dot" id="pd0"></div>
    <div class="pin-dot" id="pd1"></div>
    <div class="pin-dot" id="pd2"></div>
    <div class="pin-dot" id="pd3"></div>
  </div>
  <div class="pin-pad">
    <button class="pin-btn" onclick="pinKey('1')">1</button>
    <button class="pin-btn" onclick="pinKey('2')">2</button>
    <button class="pin-btn" onclick="pinKey('3')">3</button>
    <button class="pin-btn" onclick="pinKey('4')">4</button>
    <button class="pin-btn" onclick="pinKey('5')">5</button>
    <button class="pin-btn" onclick="pinKey('6')">6</button>
    <button class="pin-btn" onclick="pinKey('7')">7</button>
    <button class="pin-btn" onclick="pinKey('8')">8</button>
    <button class="pin-btn" onclick="pinKey('9')">9</button>
    <button class="pin-btn" onclick="pinKey('')"></button>
    <button class="pin-btn" onclick="pinKey('0')">0</button>
    <button class="pin-btn del" onclick="pinDel()">âŒ«</button>
  </div>
  <div class="pin-hint">INTRODUCE TU PIN</div>
</div>

<!-- â•â• NAV â•â• -->
<nav>
  <div class="logo">Fin<span>SQL</span></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showView('dashboard')">Dashboard</button>
    <button class="nav-tab" onclick="showView('widgets')">Mis widgets</button>
    <button class="nav-tab" onclick="showView('editor')">Editor SQL</button>
  </div>
  <div class="nav-right">
    <div class="data-status">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Sin datos</span>
    </div>
    <button class="btn-sync" id="btnSync" onclick="syncSheets()">â†» Sincronizar</button>
  </div>
</nav>

<!-- â•â• DASHBOARD VIEW â•â• -->
<div class="view active" id="view-dashboard">
  <div style="display:flex;flex-direction:column;width:100%;overflow:hidden;">
    <div class="dash-header">
      <div>
        <div class="dash-title">Dashboard</div>
        <div class="dash-subtitle" id="dashSubtitle">Carga los datos para ver el resumen</div>
      </div>
      <div class="dash-period">
        <button class="period-btn active" data-p="all" onclick="setPeriod(this)">Todo</button>
        <button class="period-btn" data-p="year" onclick="setPeriod(this)">Este aÃ±o</button>
        <button class="period-btn" data-p="month" onclick="setPeriod(this)">Este mes</button>
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi">
        <div class="kpi-label">Total Ingresos</div>
        <div class="kpi-value pos" id="kpiIngresos">â€”</div>
        <div class="kpi-sub" id="kpiIngresosN">â€”</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Total Gastos</div>
        <div class="kpi-value neg" id="kpiGastos">â€”</div>
        <div class="kpi-sub" id="kpiGastosN">â€”</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Ahorro Neto</div>
        <div class="kpi-value" id="kpiAhorro">â€”</div>
        <div class="kpi-sub" id="kpiAhorroN">â€”</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Tasa de Ahorro</div>
        <div class="kpi-value neu" id="kpiTasa">â€”</div>
        <div class="kpi-sub" id="kpiTasaN">â€”</div>
      </div>
    </div>

    <div class="chart-grid" id="chartGrid">
      <div class="chart-card wide">
        <div class="cc-header"><span class="cc-title">Ingresos vs Gastos por mes</span><span class="cc-meta" id="metaBar">â€”</span></div>
        <div class="cc-body" style="min-height:220px;"><canvas id="chartBar"></canvas><div class="no-data" id="ndBar"><div class="no-data-icon">ğŸ“Š</div><span>Sin datos</span></div></div>
      </div>
      <div class="chart-card">
        <div class="cc-header"><span class="cc-title">Ahorro neto mensual</span><span class="cc-meta" id="metaLine">â€”</span></div>
        <div class="cc-body"><canvas id="chartLine"></canvas><div class="no-data" id="ndLine"><div class="no-data-icon">ğŸ“ˆ</div><span>Sin datos</span></div></div>
      </div>
      <div class="chart-card">
        <div class="cc-header"><span class="cc-title">Gastos por categorÃ­a (Nivel 1)</span><span class="cc-meta" id="metaPie">â€”</span></div>
        <div class="cc-body"><canvas id="chartPie"></canvas><div class="no-data" id="ndPie"><div class="no-data-icon">ğŸ¥§</div><span>Sin datos</span></div></div>
      </div>
      <div class="chart-card">
        <div class="cc-header"><span class="cc-title">Top 10 subcategorÃ­as de gasto</span><span class="cc-meta" id="metaHbar">â€”</span></div>
        <div class="cc-body" style="min-height:280px;"><canvas id="chartHbar"></canvas><div class="no-data" id="ndHbar"><div class="no-data-icon">ğŸ“‹</div><span>Sin datos</span></div></div>
      </div>
      <div class="chart-card">
        <div class="cc-header"><span class="cc-title">Ingresos por categorÃ­a</span><span class="cc-meta" id="metaIngPie">â€”</span></div>
        <div class="cc-body"><canvas id="chartIngPie"></canvas><div class="no-data" id="ndIngPie"><div class="no-data-icon">ğŸ’°</div><span>Sin datos</span></div></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• WIDGETS VIEW â•â• -->
<div class="view" id="view-widgets">
  <div style="display:flex;flex-direction:column;width:100%;overflow:hidden;">
    <div class="widgets-toolbar">
      <span style="font-size:11px;color:var(--ink2);">Arrastra para reordenar Â· Clic en el tÃ­tulo para renombrar</span>
      <span style="margin-left:auto;font-size:10px;color:var(--ink3);" id="widgetCount"></span>
      <button class="btn btn-save" onclick="clearWidgets()" style="margin-left:8px;">Borrar todo</button>
    </div>
    <div class="widgets-grid" id="widgetsGrid">
      <div class="widget-empty" id="widgetEmpty">
        <div class="widget-empty-icon">ğŸ§©</div>
        <p style="font-size:12px;">TodavÃ­a no hay widgets</p>
        <p style="font-size:10px;opacity:0.6;">Crea queries en el Editor SQL y aÃ±Ã¡delas aquÃ­</p>
      </div>
    </div>
  </div>
</div>

<!-- â•â• EDITOR VIEW â•â• -->
<div class="view" id="view-editor">
  <div class="sidebar">
    <div class="sec">
      <div class="sec-label">Columnas disponibles</div>
      <div class="schema-scroll" id="schemaDiv">
        <div class="empty-hint">Sincroniza los datos primero</div>
      </div>
    </div>
    <div class="sec-label" style="padding:10px 14px 0;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);">Queries guardadas</div>
    <div class="saved-list" id="savedList">
      <div class="empty-hint" style="padding:8px;">Ninguna guardada aÃºn</div>
    </div>
  </div>

  <div class="editor-main">
    <div class="editor-toolbar">
      <div class="chart-pills" id="chartPills">
        <button class="cpill active" data-t="bar">Barras</button>
        <button class="cpill" data-t="line">LÃ­neas</button>
        <button class="cpill" data-t="pie">Tarta</button>
        <button class="cpill" data-t="horizontalBar">Horizontal</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
        <span id="queryMeta" style="font-size:10px;color:var(--ink3);"></span>
        <button class="btn btn-save" id="btnSave" onclick="openSaveModal()" disabled>Guardar query</button>
        <button class="btn btn-add" id="btnAdd" onclick="openAddModal()" disabled>+ Widget</button>
        <button class="btn btn-run" onclick="runQuery()">â–¶ Ejecutar</button>
      </div>
    </div>

    <div class="sql-wrap">
      <textarea id="sql" placeholder="-- SQL aquÃ­. La tabla se llama 'data'
-- Columnas: fecha, tipo, categoria, nivel1, nivel2, cantidad, descripcion
-- Ctrl+Enter para ejecutar"></textarea>
      <div id="errBox" style="display:none" class="err-box"></div>
    </div>

    <div class="preview-area">
      <div class="preview-chart" id="previewChart">
        <div class="no-data" id="previewEmpty"><div class="no-data-icon">ğŸ“Š</div><span>Ejecuta una query</span></div>
        <canvas id="previewCanvas" style="display:none;max-height:100%;"></canvas>
      </div>
      <div class="preview-table">
        <div class="no-data" style="padding:40px 0;" id="tableEmpty"><div class="no-data-icon">ğŸ—ƒï¸</div><span>Sin resultados</span></div>
        <table class="rtable" id="rtable" style="display:none">
          <thead id="rthead"></thead>
          <tbody id="rtbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal widget name -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>AÃ±adir widget</h3>
    <div><label>Nombre del widget</label><input type="text" id="widgetName" placeholder="Ej: Gastos por categorÃ­a"></div>
    <div class="modal-btns">
      <button class="btn btn-save" onclick="closeModal('addModal')">Cancelar</button>
      <button class="btn btn-add" onclick="confirmAdd()">AÃ±adir</button>
    </div>
  </div>
</div>

<!-- Modal save query -->
<div class="modal-overlay" id="saveModal">
  <div class="modal">
    <h3>Guardar query</h3>
    <div><label>Nombre</label><input type="text" id="queryTitle" placeholder="Ej: Ahorro neto mensual"></div>
    <div class="modal-btns">
      <button class="btn btn-save" onclick="closeModal('saveModal')">Cancelar</button>
      <button class="btn btn-run" onclick="confirmSave()">Guardar</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CORRECT_PIN = '2121';
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vToWxKfzbHsLtu1zjz_KFomXcab-lrUgXk0MvuLDKkFKUofzGBuFtwDNlXPwqtdsWPFjvPhQZ4zEYKi/pub?gid=1627954777&single=true&output=csv';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pinEntry = '';

// Check session
if (sessionStorage.getItem('finsql_auth') === '1') {
  document.getElementById('pinScreen').style.display = 'none';
}

function pinKey(k) {
  if (!k || pinEntry.length >= 4) return;
  pinEntry += k;
  updatePinDots();
  if (pinEntry.length === 4) setTimeout(checkPin, 80);
}
function pinDel() {
  pinEntry = pinEntry.slice(0, -1);
  updatePinDots();
}
function updatePinDots(cls = '') {
  for (let i = 0; i < 4; i++) {
    const d = document.getElementById('pd' + i);
    d.className = 'pin-dot' + (i < pinEntry.length ? ' filled' : '') + (cls ? ' ' + cls : '');
  }
}
function checkPin() {
  if (pinEntry === CORRECT_PIN) {
    sessionStorage.setItem('finsql_auth', '1');
    document.getElementById('pinScreen').style.animation = 'none';
    document.getElementById('pinScreen').style.opacity = '0';
    document.getElementById('pinScreen').style.transition = 'opacity 0.3s';
    setTimeout(() => document.getElementById('pinScreen').style.display = 'none', 300);
  } else {
    updatePinDots('error');
    setTimeout(() => { pinEntry = ''; updatePinDots(); }, 600);
  }
}

// Keyboard PIN
document.addEventListener('keydown', e => {
  if (document.getElementById('pinScreen').style.display === 'none') return;
  if (e.key >= '0' && e.key <= '9') pinKey(e.key);
  if (e.key === 'Backspace') pinDel();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sqlDB = null;
let SQL = null;
let previewChart = null;
let currentChartType = 'bar';
let lastResult = null;
let activePeriod = 'all';
let dashCharts = {};
let customWidgets = [];
let widgetCharts = {};
let savedQueries = [];
let dragSrc = null;

try { customWidgets = JSON.parse(localStorage.getItem('finsql_widgets') || '[]'); } catch(e) {}
try { savedQueries = JSON.parse(localStorage.getItem('finsql_queries') || '[]'); } catch(e) {}

// Init sql.js
initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}` })
  .then(s => { SQL = s; autoSync(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(v) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  const tabs = ['dashboard','widgets','editor'];
  document.querySelectorAll('.nav-tab')[tabs.indexOf(v)].classList.add('active');
  if (v === 'dashboard' && sqlDB) renderDashboard();
  if (v === 'widgets') renderWidgets();
  if (v === 'editor') renderSavedList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHEETS SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoSync() {
  // Try to sync on load if SQL is ready
  if (SQL) syncSheets();
}

async function syncSheets() {
  const btn = document.getElementById('btnSync');
  btn.disabled = true; btn.textContent = 'â†» Cargandoâ€¦';
  try {
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    loadCSVText(text);
    btn.textContent = 'â†» Sincronizar';
    btn.disabled = false;
  } catch(e) {
    btn.textContent = 'â†» Error â€” reintentar';
    btn.disabled = false;
    console.error('Sync error:', e);
    setStatus(false, 'Error al cargar');
  }
}

function loadCSVText(text) {
  const result = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: false });
  if (!result.data.length) { setStatus(false, 'CSV vacÃ­o'); return; }

  // Map columns: Fecha, Tipo, Niveles 1 y 2, Cantidad (â‚¬), DescripciÃ³n
  const raw = result.data;
  const mapped = raw.map(r => {
    const cat = (r['Niveles 1 y 2'] || r['Niveles 1 y 2 '] || '').trim();
    const parts = cat.split(' - ');
    return {
      fecha: parseDate(r['Fecha'] || ''),
      tipo: (r['Tipo'] || '').trim(),
      categoria: cat,
      nivel1: (parts[0] || '').trim(),
      nivel2: (parts.slice(1).join(' - ') || parts[0] || '').trim(),
      cantidad: parseFloat((r['Cantidad (â‚¬)'] || r['Cantidad (Ã¢â€šÂ¬)'] || '0').toString().replace(',', '.')) || 0,
      descripcion: (r['DescripciÃ³n'] || r['DescripciÃƒÂ³n'] || r['Descripcion'] || '').trim(),
    };
  }).filter(r => r.fecha && r.tipo);

  buildDB(mapped);
  const n = mapped.length;
  setStatus(true, `${n.toLocaleString()} registros`);

  const dates = mapped.map(r => r.fecha).filter(Boolean).sort();
  const from = dates[0] || ''; const to = dates[dates.length-1] || '';
  document.getElementById('dashSubtitle').textContent = `${n} registros Â· ${from} â†’ ${to}`;

  renderSchema();
  if (document.getElementById('view-dashboard').classList.contains('active')) renderDashboard();
}

function parseDate(val) {
  if (!val) return '';
  // DD/MM/YYYY â†’ YYYY-MM-DD
  const m = val.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
  // Already YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}/.test(val)) return val.slice(0,10);
  return val;
}

function buildDB(rows) {
  if (!SQL) return;
  if (sqlDB) sqlDB.close();
  sqlDB = new SQL.Database();
  sqlDB.run(`CREATE TABLE data (
    fecha TEXT, tipo TEXT, categoria TEXT,
    nivel1 TEXT, nivel2 TEXT,
    cantidad REAL, descripcion TEXT
  )`);
  const stmt = sqlDB.prepare('INSERT INTO data VALUES (?,?,?,?,?,?,?)');
  rows.forEach(r => stmt.run([r.fecha, r.tipo, r.categoria, r.nivel1, r.nivel2, r.cantidad, r.descripcion]));
  stmt.free();
}

function renderSchema() {
  const cols = [
    {name:'fecha',type:'texto'},{name:'tipo',type:'texto'},{name:'categoria',type:'texto'},
    {name:'nivel1',type:'texto'},{name:'nivel2',type:'texto'},
    {name:'cantidad',type:'nÃºmero'},{name:'descripcion',type:'texto'}
  ];
  document.getElementById('schemaDiv').innerHTML = cols.map(c =>
    `<div class="schema-row"><span class="s-name">${c.name}</span><span class="s-type">${c.type}</span></div>`
  ).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SQL RUNNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runSQL(sql) {
  if (!sqlDB) throw new Error('Sincroniza los datos primero');
  const res = sqlDB.exec(sql);
  if (!res.length) return { columns: [], rows: [] };
  const { columns, values } = res[0];
  return { columns, rows: values.map(row => { const o={}; columns.forEach((c,i)=>o[c]=row[i]); return o; }) };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERIOD FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPeriod(btn) {
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activePeriod = btn.dataset.p;
  if (sqlDB) renderDashboard();
}

function periodWhere() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  if (activePeriod === 'year') return `WHERE strftime('%Y', fecha) = '${y}'`;
  if (activePeriod === 'month') return `WHERE strftime('%Y-%m', fecha) = '${y}-${m}'`;
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PALETTE = ['#2471a3','#27ae60','#c0392b','#d35400','#8e44ad','#f39c12','#16a085','#2c3e50','#c0392b','#1abc9c','#e74c3c','#3498db'];
const PALETTE_WARM = ['#c0392b','#e74c3c','#d35400','#e67e22','#f39c12','#f1c40f','#d4ac0d','#b7950b','#a04000','#922b21'];

function destroyDashCharts() {
  Object.values(dashCharts).forEach(c => { try { c.destroy(); } catch(e){} });
  dashCharts = {};
}

function renderDashboard() {
  if (!sqlDB) return;
  destroyDashCharts();
  const w = periodWhere();
  const wAnd = w ? w.replace('WHERE','AND') : '';

  // â”€â”€ KPIs â”€â”€
  try {
    const kpi = runSQL(`SELECT
      SUM(CASE WHEN tipo='Ingreso' THEN cantidad ELSE 0 END) as ingresos,
      SUM(CASE WHEN tipo='Gasto' THEN cantidad ELSE 0 END) as gastos,
      COUNT(CASE WHEN tipo='Ingreso' THEN 1 END) as n_ing,
      COUNT(CASE WHEN tipo='Gasto' THEN 1 END) as n_gas
      FROM data ${w}`).rows[0];

    const ing = kpi?.ingresos || 0;
    const gas = kpi?.gastos || 0;
    const ahorro = ing - gas;
    const tasa = ing > 0 ? (ahorro / ing * 100) : 0;

    document.getElementById('kpiIngresos').textContent = fmt(ing);
    document.getElementById('kpiIngresosN').textContent = `${kpi?.n_ing || 0} registros`;
    document.getElementById('kpiGastos').textContent = fmt(gas);
    document.getElementById('kpiGastosN').textContent = `${kpi?.n_gas || 0} registros`;
    document.getElementById('kpiAhorro').textContent = fmt(ahorro);
    document.getElementById('kpiAhorro').className = 'kpi-value ' + (ahorro >= 0 ? 'pos' : 'neg');
    document.getElementById('kpiAhorroN').textContent = ahorro >= 0 ? 'SuperÃ¡vit' : 'DÃ©ficit';
    document.getElementById('kpiTasa').textContent = tasa.toFixed(1) + '%';
    document.getElementById('kpiTasaN').textContent = tasa >= 20 ? 'âœ“ Objetivo cumplido' : 'Objetivo: 20%';
  } catch(e) { console.error(e); }

  // â”€â”€ Barras: Ingresos vs Gastos por mes â”€â”€
  try {
    const rows = runSQL(`SELECT strftime('%Y-%m', fecha) as mes,
      SUM(CASE WHEN tipo='Ingreso' THEN cantidad ELSE 0 END) as ingresos,
      SUM(CASE WHEN tipo='Gasto' THEN cantidad ELSE 0 END) as gastos
      FROM data ${w} GROUP BY mes ORDER BY mes`).rows;

    if (rows.length) {
      document.getElementById('ndBar').style.display = 'none';
      document.getElementById('chartBar').style.display = 'block';
      document.getElementById('metaBar').textContent = `${rows.length} meses`;
      dashCharts.bar = new Chart(document.getElementById('chartBar'), {
        type: 'bar',
        data: {
          labels: rows.map(r => r.mes),
          datasets: [
            { label: 'Ingresos', data: rows.map(r => r.ingresos), backgroundColor: '#27ae6088', borderRadius: 4 },
            { label: 'Gastos', data: rows.map(r => r.gastos), backgroundColor: '#c0392b88', borderRadius: 4 },
          ]
        },
        options: chartOpts()
      });
    }
  } catch(e) { console.error(e); }

  // â”€â”€ LÃ­nea: Ahorro neto mensual â”€â”€
  try {
    const rows = runSQL(`SELECT strftime('%Y-%m', fecha) as mes,
      ROUND(SUM(CASE WHEN tipo='Ingreso' THEN cantidad ELSE 0 END) - SUM(CASE WHEN tipo='Gasto' THEN cantidad ELSE 0 END), 2) as ahorro
      FROM data ${w} GROUP BY mes ORDER BY mes`).rows;

    if (rows.length) {
      document.getElementById('ndLine').style.display = 'none';
      document.getElementById('chartLine').style.display = 'block';
      document.getElementById('metaLine').textContent = `${rows.length} meses`;
      const colors = rows.map(r => r.ahorro >= 0 ? '#27ae60' : '#c0392b');
      dashCharts.line = new Chart(document.getElementById('chartLine'), {
        type: 'bar',
        data: {
          labels: rows.map(r => r.mes),
          datasets: [{ label: 'Ahorro neto', data: rows.map(r => r.ahorro), backgroundColor: colors, borderRadius: 3 }]
        },
        options: chartOpts()
      });
    }
  } catch(e) { console.error(e); }

  // â”€â”€ Pie: Gastos por Nivel 1 â”€â”€
  try {
    const rows = runSQL(`SELECT nivel1, ROUND(SUM(cantidad),2) as total
      FROM data WHERE tipo='Gasto' ${wAnd} GROUP BY nivel1 ORDER BY total DESC`).rows;

    if (rows.length) {
      document.getElementById('ndPie').style.display = 'none';
      document.getElementById('chartPie').style.display = 'block';
      document.getElementById('metaPie').textContent = `${rows.length} categorÃ­as`;
      dashCharts.pie = new Chart(document.getElementById('chartPie'), {
        type: 'pie',
        data: {
          labels: rows.map(r => r.nivel1),
          datasets: [{ data: rows.map(r => r.total), backgroundColor: PALETTE_WARM, borderWidth: 2, borderColor: '#faf8f4' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: 'DM Mono', size: 9 }, boxWidth: 10 } } } }
      });
    }
  } catch(e) { console.error(e); }

  // â”€â”€ H-bar: Top 10 subcategorÃ­as â”€â”€
  try {
    const rows = runSQL(`SELECT nivel2, ROUND(SUM(cantidad),2) as total
      FROM data WHERE tipo='Gasto' ${wAnd} GROUP BY nivel2 ORDER BY total DESC LIMIT 10`).rows;

    if (rows.length) {
      document.getElementById('ndHbar').style.display = 'none';
      document.getElementById('chartHbar').style.display = 'block';
      document.getElementById('metaHbar').textContent = `top ${rows.length}`;
      dashCharts.hbar = new Chart(document.getElementById('chartHbar'), {
        type: 'bar',
        data: {
          labels: rows.map(r => r.nivel2),
          datasets: [{ label: 'Gasto (â‚¬)', data: rows.map(r => r.total), backgroundColor: '#2471a388', borderRadius: 3 }]
        },
        options: { ...chartOpts(), indexAxis: 'y' }
      });
    }
  } catch(e) { console.error(e); }

  // â”€â”€ Pie: Ingresos por categorÃ­a â”€â”€
  try {
    const rows = runSQL(`SELECT nivel1, ROUND(SUM(cantidad),2) as total
      FROM data WHERE tipo='Ingreso' ${wAnd} GROUP BY nivel1 ORDER BY total DESC`).rows;

    if (rows.length) {
      document.getElementById('ndIngPie').style.display = 'none';
      document.getElementById('chartIngPie').style.display = 'block';
      document.getElementById('metaIngPie').textContent = `${rows.length} categorÃ­as`;
      dashCharts.ingPie = new Chart(document.getElementById('chartIngPie'), {
        type: 'pie',
        data: {
          labels: rows.map(r => r.nivel1),
          datasets: [{ data: rows.map(r => r.total), backgroundColor: PALETTE, borderWidth: 2, borderColor: '#faf8f4' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: 'DM Mono', size: 9 }, boxWidth: 10 } } } }
      });
    }
  } catch(e) { console.error(e); }
}

function chartOpts() {
  return {
    responsive: true, maintainAspectRatio: false,
    animation: { duration: 400 },
    plugins: {
      legend: { labels: { color: '#6b6560', font: { family: 'DM Mono', size: 10 }, boxWidth: 10 } },
      tooltip: { backgroundColor: '#1a1814', titleColor: '#f5f2ec', bodyColor: '#a09a92', titleFont: { family: 'DM Mono' }, bodyFont: { family: 'DM Mono', size: 10 },
        callbacks: { label: ctx => ` ${ctx.dataset.label || ''}: ${fmtNum(ctx.parsed.y ?? ctx.parsed.x)}` }
      }
    },
    scales: {
      x: { grid: { color: '#eeeae2' }, ticks: { color: '#a09a92', font: { family: 'DM Mono', size: 9 } }, border: { color: '#ddd8ce' } },
      y: { grid: { color: '#eeeae2' }, ticks: { color: '#a09a92', font: { family: 'DM Mono', size: 9 }, callback: v => typeof v === 'number' ? fmtNum(v) : v }, border: { color: '#ddd8ce' } }
    }
  };
}

function fmt(n) { return (n||0).toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }); }
function fmtNum(n) { return (n||0).toLocaleString('es-ES', { maximumFractionDigits: 0 }); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.cpill').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.cpill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentChartType = btn.dataset.t;
    if (lastResult) renderPreviewChart(lastResult);
  });
});

function runQuery() {
  const sql = document.getElementById('sql').value.trim();
  if (!sql) return;
  if (!sqlDB) { showErr('Sincroniza los datos primero'); return; }
  hideErr();
  const t0 = performance.now();
  try {
    const result = runSQL(sql);
    const ms = Math.round(performance.now() - t0);
    lastResult = { ...result, sql, chartType: currentChartType };
    document.getElementById('queryMeta').textContent = `${ms}ms Â· ${result.rows.length} filas`;
    renderPreviewChart(lastResult);
    renderPreviewTable(result);
    document.getElementById('btnAdd').disabled = false;
    document.getElementById('btnSave').disabled = false;
  } catch(e) { showErr(e.message); }
}

function buildChartCfg(type, labels, datasets) {
  const isH = type === 'horizontalBar';
  const ct = isH ? 'bar' : type;
  const ds = datasets.map((d, i) => ({
    ...d,
    backgroundColor: type === 'pie' ? labels.map((_,j) => PALETTE[j%PALETTE.length]) : PALETTE[i%PALETTE.length] + 'bb',
    borderColor: type === 'line' ? PALETTE[i%PALETTE.length] : 'transparent',
    borderWidth: type === 'line' ? 2 : 0,
    borderRadius: ct === 'bar' ? 4 : 0,
    tension: 0.4, pointRadius: 3, fill: false,
  }));
  const opts = type === 'pie'
    ? { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#6b6560', font: { family: 'DM Mono', size: 10 }, boxWidth: 10 } } } }
    : { ...chartOpts(), indexAxis: isH ? 'y' : 'x' };
  return { type: ct, data: { labels, datasets: ds }, options: opts };
}

function r2chart(result) {
  const labels = result.rows.map(r => String(r[result.columns[0]] ?? ''));
  const valCols = result.columns.slice(1);
  return { labels, datasets: valCols.map(col => ({ label: col, data: result.rows.map(r => parseFloat(r[col]) || 0) })) };
}

function renderPreviewChart(result) {
  const canvas = document.getElementById('previewCanvas');
  const empty = document.getElementById('previewEmpty');
  if (!result.rows.length || result.columns.length < 2) { canvas.style.display='none'; empty.style.display='flex'; return; }
  if (previewChart) previewChart.destroy();
  const { labels, datasets } = r2chart(result);
  canvas.style.display = 'block'; empty.style.display = 'none';
  previewChart = new Chart(canvas, buildChartCfg(currentChartType, labels, datasets));
}

function renderPreviewTable({ columns, rows }) {
  const thead = document.getElementById('rthead'), tbody = document.getElementById('rtbody');
  document.getElementById('rtable').style.display = 'table';
  document.getElementById('tableEmpty').style.display = 'none';
  thead.innerHTML = `<tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>`;
  tbody.innerHTML = rows.slice(0,60).map(row => `<tr>${columns.map(col => {
    const v = row[col]; const n = parseFloat(v); const isN = !isNaN(n) && v !== '' && v !== null;
    return `<td class="${isN?'num':''}">${isN ? n.toLocaleString('es-ES',{maximumFractionDigits:2}) : (v??'â€”')}</td>`;
  }).join('')}</tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVED QUERIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSaveModal() {
  document.getElementById('queryTitle').value = '';
  document.getElementById('saveModal').classList.add('open');
  setTimeout(() => document.getElementById('queryTitle').focus(), 50);
}
function confirmSave() {
  const title = document.getElementById('queryTitle').value.trim() || 'Query';
  savedQueries.push({ id: Date.now().toString(), title, sql: document.getElementById('sql').value.trim() });
  localStorage.setItem('finsql_queries', JSON.stringify(savedQueries));
  closeModal('saveModal');
  renderSavedList();
}
function renderSavedList() {
  const list = document.getElementById('savedList');
  if (!savedQueries.length) { list.innerHTML = '<div class="empty-hint" style="padding:8px;">Ninguna guardada aÃºn</div>'; return; }
  list.innerHTML = savedQueries.map(q => `
    <div class="saved-item" onclick="loadQuery('${q.id}')">
      <span class="saved-item-title">${escHtml(q.title)}</span>
      <button class="saved-item-del" onclick="event.stopPropagation();deleteSaved('${q.id}')">âœ•</button>
    </div>`).join('');
}
function loadQuery(id) {
  const q = savedQueries.find(q => q.id === id);
  if (q) document.getElementById('sql').value = q.sql;
}
function deleteSaved(id) {
  savedQueries = savedQueries.filter(q => q.id !== id);
  localStorage.setItem('finsql_queries', JSON.stringify(savedQueries));
  renderSavedList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOM WIDGETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal() {
  if (!lastResult) return;
  document.getElementById('widgetName').value = '';
  document.getElementById('addModal').classList.add('open');
  setTimeout(() => document.getElementById('widgetName').focus(), 50);
}
function confirmAdd() {
  const name = document.getElementById('widgetName').value.trim() || 'Widget';
  customWidgets.push({ id: Date.now().toString(), title: name, sql: lastResult.sql, chartType: currentChartType, columns: lastResult.columns, rows: lastResult.rows });
  localStorage.setItem('finsql_widgets', JSON.stringify(customWidgets));
  closeModal('addModal');
  showView('widgets');
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if(e.target===e.currentTarget) m.classList.remove('open'); }));
document.getElementById('widgetName').addEventListener('keydown', e => { if(e.key==='Enter') confirmAdd(); if(e.key==='Escape') closeModal('addModal'); });
document.getElementById('queryTitle').addEventListener('keydown', e => { if(e.key==='Enter') confirmSave(); if(e.key==='Escape') closeModal('saveModal'); });

function saveWidgets() { localStorage.setItem('finsql_widgets', JSON.stringify(customWidgets)); }

function clearWidgets() {
  if (!customWidgets.length) return;
  if (!confirm('Â¿Borrar todos los widgets?')) return;
  customWidgets = []; saveWidgets(); renderWidgets();
}

function renderWidgets() {
  Object.values(widgetCharts).forEach(c => { try { c.destroy(); } catch(e){} });
  widgetCharts = {};
  const grid = document.getElementById('widgetsGrid');
  document.getElementById('widgetCount').textContent = customWidgets.length ? `${customWidgets.length} widgets` : '';
  if (!customWidgets.length) {
    grid.innerHTML = '';
    grid.appendChild(document.getElementById('widgetEmpty'));
    return;
  }
  grid.innerHTML = customWidgets.map(w => `
    <div class="widget" id="w-${w.id}" draggable="true"
         ondragstart="wDragStart(event,'${w.id}')" ondragover="wDragOver(event,'${w.id}')"
         ondragleave="wDragLeave(event,'${w.id}')" ondrop="wDrop(event,'${w.id}')">
      <div class="widget-header">
        <span class="drag-handle">â ¿</span>
        <input class="widget-title" value="${escHtml(w.title)}" onblur="renameWidget('${w.id}',this.value)" onkeydown="if(event.key==='Enter')this.blur()">
        <div class="wct-row">
          ${['bar','line','pie','horizontalBar'].map(t => `<button class="wct-btn ${w.chartType===t?'active':''}" onclick="changeWType('${w.id}','${t}')">${t==='bar'?'B':t==='line'?'L':t==='pie'?'T':'H'}</button>`).join('')}
        </div>
        <button class="wa-btn" onclick="deleteWidget('${w.id}')">âœ•</button>
      </div>
      <div class="widget-body"><canvas id="wc-${w.id}"></canvas></div>
      <div class="widget-footer"><span>${w.rows.length} filas</span><span>${truncate(w.sql,55)}</span></div>
    </div>`).join('');

  customWidgets.forEach(w => {
    const canvas = document.getElementById('wc-'+w.id);
    if (!canvas || !w.rows.length || w.columns.length < 2) return;
    const { labels, datasets } = r2chart(w);
    try { widgetCharts[w.id] = new Chart(canvas, buildChartCfg(w.chartType, labels, datasets)); } catch(e){}
  });
}

function renameWidget(id, val) {
  const w = customWidgets.find(w=>w.id===id);
  if (w) { w.title = val.trim()||w.title; saveWidgets(); }
}
function deleteWidget(id) {
  customWidgets = customWidgets.filter(w=>w.id!==id);
  saveWidgets();
  if (widgetCharts[id]) { try { widgetCharts[id].destroy(); } catch(e){} delete widgetCharts[id]; }
  renderWidgets();
}
function changeWType(id, type) {
  const w = customWidgets.find(w=>w.id===id);
  if (!w) return;
  w.chartType = type; saveWidgets();
  const card = document.getElementById('w-'+id);
  if (card) card.querySelectorAll('.wct-btn').forEach(b => b.classList.toggle('active', b.textContent===(type==='bar'?'B':type==='line'?'L':type==='pie'?'T':'H')));
  if (widgetCharts[id]) { try { widgetCharts[id].destroy(); } catch(e){} delete widgetCharts[id]; }
  const canvas = document.getElementById('wc-'+id);
  if (canvas && w.rows.length && w.columns.length >= 2) {
    const { labels, datasets } = r2chart(w);
    try { widgetCharts[id] = new Chart(canvas, buildChartCfg(type, labels, datasets)); } catch(e){}
  }
}

// Drag & drop
function wDragStart(e,id) { dragSrc=id; e.dataTransfer.effectAllowed='move'; setTimeout(()=>{ const el=document.getElementById('w-'+id); if(el) el.classList.add('dragging'); },0); }
function wDragOver(e,id) { e.preventDefault(); if(id!==dragSrc){ const el=document.getElementById('w-'+id); if(el) el.classList.add('drag-over'); } }
function wDragLeave(e,id) { const el=document.getElementById('w-'+id); if(el) el.classList.remove('drag-over'); }
function wDrop(e,id) {
  e.preventDefault();
  const el=document.getElementById('w-'+id); if(el) el.classList.remove('drag-over');
  const srcEl=document.getElementById('w-'+dragSrc); if(srcEl) srcEl.classList.remove('dragging');
  if(id===dragSrc) return;
  const si=customWidgets.findIndex(w=>w.id===dragSrc), di=customWidgets.findIndex(w=>w.id===id);
  if(si<0||di<0) return;
  const [item]=customWidgets.splice(si,1); customWidgets.splice(di,0,item);
  saveWidgets(); renderWidgets();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showErr(msg) { const e=document.getElementById('errBox'); e.textContent='âš  '+msg; e.style.display='block'; }
function hideErr() { document.getElementById('errBox').style.display='none'; }
function setStatus(on, txt) {
  document.getElementById('statusDot').className='status-dot'+(on?' on':'');
  document.getElementById('statusText').textContent=txt;
}
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function truncate(s,n) { return s.length>n ? s.slice(0,n)+'â€¦' : s; }

document.getElementById('sql').addEventListener('keydown', e => { if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)) runQuery(); });
</script>
</body>
</html>
